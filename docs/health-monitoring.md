# 公共健康检查监控页方案

本文档定义“免登录可访问的健康检查监控页”目标、后端巡检架构、数据模型、API、前端信息架构、安全与上线方案

## 1. 目标与范围
- 免登录公开页面聚合展示：可用率、延迟分位（P50/P95）、错误分布、24h/7d 趋势。
- 后端定期对“目标”（模型/虚拟模型/提供商）执行最小化会话健康检查，入库并对外公开只读聚合 API。
- 可按目标配置检查提示词、判定规则、频率与阈值，并发与超时可控。
- 默认对公开 API 做缓存与限流，平衡性能与成本。

## 2. 术语
- 目标（Target）：被巡检的对象，类型可为“模型”“虚拟模型”。
- 运行（Run）：一次健康检查的事实记录。
- 汇总（Summary）：对一段时间窗口内运行数据的聚合快照。

## 3. 架构选型
- 方案A（快速版）：进程内定时调度（单实例优先），控制并发与超时；上线快、零依赖。

## 4. 检查口径与判定
- 可用性：HTTP 成功且响应结构合法、文本非空。
- 延迟：记录总耗时（必选）与可获取的阶段耗时，形成 P50/P95。
- 质量近似：关键字命中、JSON 可解析性、是否包含拒答模式等启发式判定。
- 错误分类：认证、额度/限流、超时、上游 5xx、协议解析等。
- 频率：默认 1/5/15 分钟可选；昂贵模型可降低频率。
- 并发：每目标/每提供商并发上限，避免限流与成本暴涨。
- 超时与重试：超时 20–30s；失败可 1 次快速重试；连续 N 失败触发熔断，M 成功恢复。

## 6. API 设计（公开只读，免鉴权）
- GET /public/health/summary
  - 所有目标的当前状态、1h/24h 可用率、P50/P95、黄绿蓝色块状态指示
- GET /public/health/targets
  - 目标清单与元信息（名称、类型、分组标签）。
- GET /public/health/detail?target_id=...
  - 单目标概览：当前状态、最近成功/失败、错误与时延分布。
- GET /public/health/runs?target_id=...&window=24h&page=1&page_size=50
  - 明细分页列表，用于排障追溯。

## 7. 服务端实现要点
- 调度：扫描 health_targets 选择到期目标，分批执行；多实例场景使用分布式锁或队列避免重复。
- 执行：通过现有网关路径发起最小化会话请求，复用真实路由策略；记录 request_id 便于与请求日志对齐。
- 聚合：按时间窗口聚合 runs，接口端 15–60s 短缓存；高并发再落地 summaries 物化。
- 可观测：埋点“开始/成功/失败/熔断”，错误类别与上游信息脱敏。

## 8. 前端公开页面设计
- 路由：新增 /status 或 /public/health；前端路由守卫放行，参考 [web/src/router/index.ts](web/src/router/index.ts)。
- 布局：
  - 顶部总览卡：整体可用率（24h/7d）、当前状态、目标数、异常数。
  - 筛选区：分组（模型系列/提供商）、关键字、状态筛选（OK/Degraded/Down）。
  - 目标列表/网格：名称、类型标签、状态灯、P50/P95、24h 可用率、趋势线；点击入详情抽屉/页面。
  - 侧栏“最近异常”：滚动列出最新失败。
- 刷新：默认 60s 自动刷新，支持手动刷新；可选实时模式使用 SSE。
- 视觉：状态色（绿/黄/红）与色盲友好；明暗主题；首屏仅加载 summary，详情再请求 runs。

## 9. 安全与合规
- 脱敏：不展示真实密钥/内部 ID；错误仅展示类别与摘要，不含原始请求体。
- 可配置：后台开关公开页；可选随机路径或只读令牌（默认仍免登录）。
- 安全头：仅允许 GET，设置合理 Cache-Control 与常见安全头部。

## 10. 上线计划
- 建表与索引：按“数据模型”创建三表与索引。
- 缺省配置：预置少量关键目标（如核心虚拟模型），频率与阈值采用保守值。
- 灰度：先在测试/小流量启用，观察成本与速率，再扩大覆盖。
- 监控：关键日志与错误告警（可选 Webhook/邮件/IM）。

## 11. 最小可行版本（MVP）
- 后端：方案A 调度、仅写 runs、接口实时聚合 + 短缓存、四个公开 API（summary/targets/detail/runs）。
- 前端：新增 /status 页面，含总览 + 列表 + 详情抽屉，60s 自动刷新。
- 安全：响应与日志脱敏、公开 API 限流与缓存。
- 文档：在 [docs/docker-deployment.md](docs/docker-deployment.md) 加“公开监控页”章节；在 [README.md](README.md) 补充入口与开关说明。
